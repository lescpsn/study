<!-- doc/src/sgml/release-3.6.sgml -->
<!-- See header comment in release.sgml about typical markup -->

<sect1 id="release-3-6">
  <title>Release 3.6</title>

  <note>
    <title>Release Date</title>
    <simpara>2016-11-21</simpara>
  </note>

  <sect2>
    <title>Overview</title>

    <para>
      Major enhancements in <productname>Pgpool-II</productname> 3.6 include:
    </para>

    <!-- Items in this list summarize one or more items below -->

    <itemizedlist>

      <listitem>
	<para>
	  Improve the behavior of fail-over. In the steaming
	  replication mode, client sessions will not be disconnected
	  when a fail-over occurs any more if the session does not use
	  the failed standby server. If the primary server goes down,
	  still all sessions will be disconnected. Also it is possible
	  to connect to <productname>Pgpool-II</productname> even if
	  it is doing health checking retries. Before all attempt of
	  connecting to <productname>Pgpool-II</productname> failed
	  while doing health checking retries.
	</para>
      </listitem>

      <listitem>
	<para>
	  New PGPOOL SET command has been introduced. Certain
	  configuration parameters now can be changed on the fly in a
	  session.
	</para>
      </listitem>

      <listitem>
	<para>
	  Watchdog is significantly enhanced. It becomes more reliable
	  than previous releases.
	</para>
      </listitem>

      <listitem>
	<para>
	  Handling of extended query protocol (e.g. used by Java
	  applications) in streaming replication mode speeds up if
	  many rows are returned in a result set.
	</para>
      </listitem>

      <listitem>
	<para>
	  Import parser of PostgreSQL 9.6.
	</para>
      </listitem>

      <listitem>
	<para>
	  In some cases pg_terminate_backend() now does not trigger a
	  fail-over.
	</para>
      </listitem>

      <listitem>
	<para>
	  Change documentation format from raw HTML to SGML.
	</para>
      </listitem>

    </itemizedlist>

    <para>
      The above items are explained in more detail in the sections below.
    </para>

  </sect2>

  <sect2>
    <title>Major Enhancements</title>

    <itemizedlist>

      <listitem>
	<!--
	    2016-04-17 [259cdf9] Do not restart child process if certain conditions met
	    2016-04-21 [9cc243a] Minimize the chance of session disconnection while failover
	    2016-05-05 [0d66032] Allow to access to pgpool while doing health checking
	  -->
	<para>
	  Improve the behavior of fail-over. (Tatsuo Ishii)
	</para>
	<para>
	  In the steaming replication mode, client sessions will not
	  be disconnected when a fail-over occurs any more if the
	  session does not use the failed standby server. If the
	  primary server goes down, still all sessions will be
	  disconnected. Health check timeout case will also cause the
	  full session disconnection. Other health check error,
	  including retry over case does not trigger full session
	  disconnection.
	</para>

	<para>
	  For user's convenience, "show pool_nodes" command shows the
	  session local load balance node info since this is important
	  for users in case of fail-over. If the load balance node is
	  not the failed node, the session will not be affected by
	  fail-over.
	</para>

	<para>
	  Also now it is possible to connect
	  to <productname>Pgpool-II</productname> even if it is doing
	  health checking retries. Before all attempt of connecting
	  to <productname>Pgpool-II</productname> failed while doing
	  health checking retries.  Before any attempt to connect to
	  <productname>Pgpool-II</productname> fails if it is doing a
	  health check against failed node even if
	  <xref linkend="guc-fail-over-on-backend-error"> is off
	  because <productname>Pgpool-II</productname> child first
	  tries to connect to all backend including the failed one and
	  exits if it fails to connect to a backend (of course it
	  fails). This is a temporary situation and will be resolved
	  once pgpool executes fail-over. However if the health check
	  is retrying, the temporary situation keeps longer depending
	  on the setting
	  of <xref linkend="guc-health-check-max-retries"> and
	  <xref linkend="guc-health-check-retry-delay">. This is not
	  good. Attached patch tries to mitigate the problem:
	</para>
	<para>
	  When an attempt to connect to backend fails, give up
	  connecting to the failed node and skip to other node, rather
	  than exiting the process if operating in streaming
	  replication mode and the node is not primary node.
	</para>
	<para>
	  Mark the local status of the failed node to "down".  This
	  will let the primary node be selected as a load balance node
	  and every queries will be sent to the primary node. If
	  there's other healthy standby nodes, one of them will be
	  chosen as the load balance node.
	</para>
	<para>
	  After the session is over, the child process will suicide to
	  not retain the local status.
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-05-22 [b9955ce] Adding new PGPOOL SET and PGPOOL RESET commands.
	    2016-05-11 [25dc79e] Adding new SHOW command for pgpool-II configuration parameters.
	  -->
	<para>
	  Add <link linkend="SQL-PGPOOL-SHOW">PGPOOL
	  SHOW</link>, <link linkend="SQL-PGPOOL-SET">PGPOOL
	  SET</link> and
	  <link linkend="SQL-PGPOOL-RESET">PGPOOL RESET</link>
	  commands. (Muhammad Usama)
	</para>
	<para>
	  These are similar to the PostgreSQL's SET and SHOW commands
	  for GUC variables, adding the functionality
	  in <productname>Pgpool-II</productname> to set and reset the
	  value of config parameters for the current session, and for
	  that it adds a new syntax
	  in <productname>Pgpool-II</productname> which is similar to
	  PostgreSQL's SET and RESET variable syntax with an addition
	  of <literal>PGPOOL</literal> keyword at the start.
	</para>
	<para>
	  Currently supported configuration parameters by PGPOOL
	  SHOW/SET/RESET are: <xref linkend="guc-log-statement">,
	  <xref linkend="guc-log-per-node-statement">, <xref linkend="guc-check-temp-table">,
	  <xref linkend="guc-check-unlogged-table">, <xref linkend="guc-allow-sql-comments">,
	  <xref linkend="guc-client-idle-limit">, <xref linkend="guc-log-error-verbosity">,
	  <xref linkend="guc-client-min-messages">, <xref linkend="guc-log-min-messages">,
	  <xref linkend="guc-client-idle-limit-in-recovery">.
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-08-02 [bda946e] Fix for 218: Inconsistent status of
	    Postgresql nodes in pgPool instances after
	    restart. Watchdog not syncing status.
	  -->
	<para>
	  Sync inconsitent status
	  of <productname>PostgreSQL</productname> nodes
	  in <productname>Pgpool-II</productname> instances after
	  restart. (bug 218) (Muhammad Usama)
	</para>
	<para>
    Watchdog does not synchronize status.
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-09-06 [c0eb0ee] Enhance performance of SELECT when lots of rows involved.
	  -->
	<para>
	  Enhance performance of SELECT when lots of rows involved.
	  (Tatsuo Ishii)
	</para>
	<para>
	  <productname>Pgpool-II</productname> flushes data to network
	  (calling write(2)) every time it sends a row data ("Data
	  Row" message) to frontend. For example, if 10,000 rows
	  needed to be transfer, 10,000 times write()s are
	  issued. This is pretty expensive. Since after repeating to
	  send row data, "Command Complete" message is sent, it's
	  enough to issue a write() with the command complete
	  message. Also there are unnecessary flushing are in handling
	  the command complete message.
	</para>
	<para>
	  <ulink url="http://www.pgpool.net/pipermail/pgpool-hackers/2016-September/001784.html">Quick
	  testing</ulink> showed that from 47% to 62% performance
	  enhancements were achieved in some cases.
	</para>
	<para>
	  Unfortunately, performance in workloads where transferring
	  few rows, will not be enhanced since such rows are needed to
	  flush to network anyway.
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-08-26 [d768944] import PostgreSQL 9.6 parser
	  -->
	<para>
	  Import <productname>PostgreSQL</productname> 9.6's SQL
	  parser. (Bo Peng)
	</para>
	<para>
	  This allows <productname>Pgpool-II</productname> to fully
	  understand the newly added SQL syntax such as <literal>COPY
	  INSERT RETURNING</literal>.
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-08-26 [f284be4] Handling of pg_terminate_backend for simple query protocol
	  -->
	<para>
	  In some cases <function>pg_terminate_backend()</function> now does not trigger a fail-over. (Muhammad Usama)
	</para>
	<para>
    Because PostgreSQL returns exactly the same error code as postmaster
    down case and <function>pg_terminate_backend()</function> case, using
    <function>pg_terminate_backend()</function> raises a failover which user might not want. To
    fix this, now <productname>Pgpool-II</productname> finds a pid of backend which is the target of
    <function>pg_terminate_backend()</function> and does not trigger failover if so.
    </para>
    <para>
    This functions is limited to the case of simple protocol and the pid
    is given to <function>pg_terminate_backend()</function> as a constant. So if you call
    <function>pg_terminate_backend()</function> via extended protocol (e.g. Java) still
    <function>pg_terminate_backend()</function> triggers a failover.
    </para>
      </listitem>

      <listitem>
	<!--
	    2016-03-15 [47d9af9] Mega patch to add SGML docs.
	  -->
	<para>
          HTML documents are now generated from SGML documents.
          (Muhammad Usama, Tatsuo Ishii, Bo Peng)
	</para>
	<para>
	  It is intended to have better construction, contents and
          maintainability. Also man pages are now generated from SGML.
	  However, still there's tremendous room to
          enhance the SGML documents. Please help us!
	</para>
      </listitem>

    </itemizedlist>
  </sect2>

  <sect2>
    <title>Other Enhancements</title>

    <itemizedlist>

      <listitem>
	<!--
	    2016-08-24 [0f4d1de] Make authentication error message more user friendly.
	  -->

	<para>
	  Make authentication error message more user friendly. (Tatsuo Ishii)
	</para>
	<para>
	  When attempt to connect to backend (including health
	  checking), emit error messages from backend something like
	  "sorry, too many clients already" instead of "invalid
	  authentication message response type, Expecting 'R' and
	  received '%c'"
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-08-22 [2088a17] Tighten up health check timer expired condition in pool_check_fd()
	  -->
	<para>
	  Tighten up health check timer expired condition in pool_check_fd(). (Muhammad Usama)
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-07-29 [6ff2ac0] Add new script called "watchdog_setup".
	    2016-08-18 [d3211dc] Let watchdog_setup to be installed.
	  -->
	<para>
	  Add new script called "watchdog_setup". (Tatstuo Ishii)
	</para>
	<para>
	  <xref linkend="WATCHDOG-SETUP"> is a command to create a
	  temporary installation
	  of <productname>Pgpool-II</productname> clusters with
	  watchdog for mainly testings.
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-07-29 [cf319c4] Add "-pg" option to pgpool_setup.
	    2016-08-16 [d5c3cf2]  Let pgpool_setup install into dist bin.
	  -->
	<para>
	  Add "-pg" option to pgpool_setup. (Tatsuo Ishii)
	</para>
	<para>
	  This is useful when you want to assign specific port numbers to
	  <productname>PostgreSQL</productname> while
	  using <xref linkend="PGPOOL-SETUP">. Also
	  now <command>pgpool_setup</command> is installed in the
	  standard bin directory which is same
	  as <command>pgpool</command>.
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-08-12 [9db83a8] Add "replication delay" column to "show pool_nodes".
	  -->
	<para>
	  Add "replication delay" column to "show pool_nodes". (Tatsuo Ishii)
	</para>
	<para>
	  This column
	  shows the <link linkend="runtime-streaming-replication-check">
	  replication delay</link> value in bytes if operated in
	  streaming replication mode.
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-07-12 [726cb5d] Do not update status file if all backend nodes are in down status.
	  -->
	<para>
	  Do not update status file if all backend nodes are in down status. (Chris Pacejo, Tatsuo Ishii)
	</para>
	<para>
	  This commit tries to remove the data inconsitency in
	  replication mode found
	  in <ulink url="http://www.pgpool.net/pipermail/pgpool-general/2015-August/003974.html">[pgpool-general:
	  3918]</ulink> by not recording the status file when all
	  backend nodes are in down status.  This surprisingly simple
	  but smart solution was provided by Chris Pacejo.
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-05-23 [9342472] Permit pgpool to support multiple SSL cipher protocols
	  -->
	<para>
	  Allow to use multiple SSL cipher protocols. (Muhammad Usama)
	</para>
	<para>
	  By replacing TLSv1_method() with SSLv23_method() while
	  initializing the SSL session, we can use more protocols than
	  TLSv1 protocol.
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-04-07 [0e01d32] removing the limit on the maximum number
        of items in the black_function_list and white_function_list lists.
	  -->
	<para>
	  Allow to use arbitrary number of items in the
	  black_function_list/white_function_list. (Muhammad Usama)
	</para>
	<para>
	  Previously there were fixed limits for those.
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-02-17 [f2a5081] Properly process empty query (all comments)
	  -->
	<para>
	  Properly process empty queries (all comments). (Tatsuo Ishii)
	</para>
	<para>
	  <productname>Pgpool-II</productname> now recognizes an empty
	  query consisted of all comments (for example "/* DBD::Pg
	  ping test v3.5.3 */") (note that no ';') as an empty query.
	  </para>
	<para>
	  Before such that query was recognized an error.
	</para>
      </listitem>

      <listitem>
	<!--
	    2016-02-01 [342471f] Add some warning messages for wd_authkey hash calculation failure
	  -->
	<para>
	  Add some warning messages for wd_authkey hash calculation failure. (Yugo Nagata)
	</para>
	<para>
	  Sometimes wd_authkey calculation fails for some reason other
	  than authkey mismatch. The additional messages make these
	  distinguishable for each other.
	</para>
      </listitem>

    </itemizedlist>

  </sect2>

  <sect2>
    <title>Changes</title>

    <itemizedlist>
      <listitem>
        <!--
            2016-11-09 [f6ec434] Fix the broken log_destination = syslog functionality.
        -->
        <para>
        Fix the broken log_destination = syslog functionality. (Muhammad Usama)
        </para>
        <para>
        Fixing the logging to the syslog destination, which got broken by the
        PGPOOL SET/SHOW command commit, and also enhancing the log_destination
        configuration parameter to be assigned with the comma separated list of multiple
        destinations for the <productname>Pgpool-II</productname> log. Now, after this commit log_destination can
        be set to any combination of 'syslog' and 'stderr' log destinations.
        </para>
      </listitem>
      <listitem>
	<!--
	    2016-09-24 [cc33fe3] Change the default value of search_primary_node_timeout from 10 to 300.
	  -->
			<para>
            Change the default value of
            <xref linkend="guc-search-primary-node-timeout"> from 10 to 300. (Tatstuo Ishii)
			</para>
			<para>
            Prior default value 10 seconds is sometimes too short for a standby to
            be promoted.
			</para>
      </listitem>

      <listitem>
          <!--
            2016-06-09 [7671794] Change the Makefile under directory src/sql/,that is proposed by [pgpool-hackers: 1611]
            -->
			<para>
			Change the <filename>Makefile</filename> under directory
            <filename>src/sql/</filename>, that is proposed by
            <ulink url="http://www.pgpool.net/pipermail/pgpool-hackers/2016-June/001611.html">
            [pgpool-hackers: 1611]</ulink>. (Bo Peng)
			</para>

      </listitem>
      <listitem>
			  <!--
				  2016-04-20 [883d761] Change the PID length of pcp_proc_count command output to 6 characters long
				-->
			<para>
				Change the PID length of <link linkend="PCP-PROC-COUNT">pcp_proc_count</link> command output to 6 characters long. (Bo Peng)
			</para>
            <para>
                If the <productname>Pgpool-II</productname> process ID are over 5 characters, the 6th character of each process ID
                will be removed. This commit changes the process ID length of <link linkend="PCP-PROC-COUNT">pcp_proc_count</link> command
                output to 6 characters long.
            </para>
      </listitem>
      <listitem>
            <!--
		        2016-04-15 [9b62eca] Redirect all user queries to primary server
            -->
            <para>
			    Redirect all user queries to primary server. (Tatsuo Ishii)
            </para>
            <para>
               Up to now some user queries are sent to other than the primary server
               even if <xref linkend="guc-load-balance-mode"> = off. This commit changes the behavior: if
               load_balance_mode = off in streaming replication mode, now all the
               user queries are sent to the primary server only.
            </para>
      </listitem>
    </itemizedlist>
  </sect2>

  <sect2>
    <title>Bug fixes</title>

    <itemizedlist>
      <listitem>
      <!--
      2016-11-14 [266b67a]  Fixing a potential crash in pool_stream functions.
      -->
      <para>
      Fixing a potential crash in pool_stream functions. (Muhammad Usama)
      </para>
      <para>
      POOL_CONNECTION->con_info should be checked for null value before de-referencing
      when read or write fails on backend socket.
      </para>
      </listitem>
      <listitem>
      <!--
      2016-11-14 [ef6c0c8] Fixing the design of failover command propagation on watchdog cluster
      -->
      <para>
      Fixing the design of failover command propagation on watchdog cluster. (Muhammad Usama)
      </para>
      <para>
      Overhauling the design of how failover, failback and promote node commands are
      propagated to the watchdog nodes. Previously the watchdog on pgpool-II node that
      needs to perform the node command (failover, failback or promote node) used to
      broadcast the failover command to all attached pgpool-II nodes. And this
      sometimes makes the synchronization issues, especially when the watchdog cluster
      contains a large number of nodes and consequently the failover command sometimes
      gets executed by more than one <productname>Pgpool-II</productname>.
      </para>
      <para>
      Now with this commit all the node commands are forwarded to the
      master/coordinator watchdog, which in turn propagates to all standby nodes.
      Apart from above the commit also changes the failover command interlocking
      mechanism and now only the master/coordinator node can become the lock holder
      so the failover commands will only get executed on the master/coordinator node.
      </para>
      </listitem>
      <listitem>
        <!--
            2016-09-27 [a7e459f] Fix the case when all backends are down then 1 node attached.
            -->
        <para>
        Fix the case when all backends are down then 1 node attached. (Tatsuo Ishii)
        </para>
        <para>
        When all backends are down, no connection is accepted. Then 1
        <productname>PostgreSQL</productname> becomes up, and attach the node using pcp_attach_node. It
        successfully finishes. However, when a new connection arrives, still
        the connection is refused because<productname>Pgpool-II</productname> child process looks into the
        cached status, in which the recovered node is still in down status if
        mode is streaming replication mode (native replication and other modes
        are fine). Solution is, if all nodes are down, force to restart all
        pgpool child.
        </para>
      </listitem>
      <listitem>
        <!--
        2016-09-19 [e89e365] Fix for: [pgpool-general: 4997] Avoiding downtime when pgpool changes require a restart
            -->
        <para>
	    Fix for avoiding downtime when <productname>Pgpool-II</productname> changes require a restart. (Muhammad Usama)
        </para>
        <para>
        To fix this, the verification mechanism of configuration parameter values is
        reversed, previously the standby nodes used to verify their parameter values
        against the respective values on the master <productname>Pgpool-II</productname> node and when the
        inconsistency was found the FATAL error was thrown, now with this commit the
        verification responsibility is delegated to the master <productname>Pgpool-II</productname> node.
        Now the master node will verify the configuration parameter values of each
        joining standby node against its local values and will produce
        a WARNING message instead of an error in case of a difference.
        This way the nodes having the different configurations will also be allowed to
        join the watchdog cluster and the user has to manually look out for the
        configuration inconsistency warnings in the master <productname>Pgpool-II</productname> log to avoid the
        surprises at the time of <productname>Pgpool-II</productname> master switch over.
        </para>
      </listitem>
      <listitem>
        <!--
            2016-09-19 [233ae46] Fixing a problem with the watchdog failover_command locking mechanism
            -->
        <para>
	    Fix a problem with the watchdog <xref linkend="guc-failover-command"> locking mechanism. (Muhammad Usama)
        </para>
      </listitem>
      <listitem>
      <!--
            2016-09-12 [b412da2] Disable strict aliasing optimization.
        -->
        <para>
        Add compiler flag "-fno-strict-aliasing" in <filename>configure.ac</filename> to fix compiler error. (Tatsuo Ishii)
        </para>
      </listitem>
      <listitem>
      <!--
        2016-09-09 [650c660] Do not use random() while generating MD5 salt.
        -->
        <para>
	    Do not use <function>random()</function> while generating MD5 salt. (Tatsuo Ishii)
        </para>
        <para>
        <function>random()</function> should not be used in security related applications.  To
        replace <function>random()</function>, import <function>PostmasterRandom()</function> from PostgreSQL.  Also
        store current time at the start up of <productname>Pgpool-II</productname> main process for later
        use.
        </para>

      </listitem>
      <listitem>
      <!--
        2016-09-05 [455df3d] Don't ignore sync message from frontend when query cache is enabled.
        -->
        <para>
	    Don't ignore sync message from frontend when query cache is enabled. (Tatsuo Ishii)
        </para>
      </listitem>
      <listitem>
      <!--
        2016-08-29 [4c23c9b] Fix for 237: Pgpool-II fails to start if listen_addresses is empty string
        -->
        <para>
	    Fix bug that <productname>Pgpool-II</productname> fails to start if <xref linkend="guc-listen-addresses"> is empty string. (bug 237) (Muhammad Usama)
        </para>
        <para>
        The socket descriptor array (fds[]) was not getting the array end marker
        when TCP listen addresses are not used.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-08-22 [879d16a] Create regression log directory if it does not exist yet.
        -->
        <para>
	    Create regression log directory if it does not exist yet. (Tatsuo Ishii)
        </para>
      </listitem>
      <listitem>
      <!--
        2016-08-17 [37e376e] Fixing the error messages when the socket operation fails
        -->
        <para>
	    Fixing the error messages when the socket operation fails. (Muhammad Usama)
        </para>
      </listitem>
      <listitem>
      <!--
        2016-08-15 [f2b5d17]  Fix regression failure of 003.failover.
        -->
        <para>
	    Update regression test 003.failover to reflect the changes made to
        <link linkend="SQL-SHOW-POOL-NODES">show pool_nodes</link>. (Tatsuo Ishii)
        </para>
      </listitem>
      <listitem>
      <!--
        2016-08-09 [a7bc4c8] Fix hang when portal suspend received
        -->
        <para>
	    Fix hang when portal suspend received. (bug 230) (Tatsuo Ishii)
        </para>
      </listitem>
      <listitem>
      <!--
        2016-08-04 [3b2db66] Fix for 228: pgpool doesn't de-escalate IP in case network restored
        -->
        <para>
	    Fix pgpool doesn't de-escalate IP in case network restored. (bug 228) (Muhammad Usama)
        </para>
        <para>
        set_state function is made to de-escalate, when it is changing the local node's
        state from the coordinator state to some other state.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-08-02 [9b122ab]  SIGUSR1 signal handler should be installed before watchdog initialization.
        -->
        <para>
	    SIGUSR1 signal handler should be installed before watchdog initialization. (Muhammad Usama)
        </para>
        <para>
        Since there can be a case where a failover request from other watchdog nodes
        arrive at the same time when the watchdog has just been initialized,
        and if we wait any longer to install a SIGUSR1 signal handler, it can
        result in a potential crash
        </para>
      </listitem>
      <listitem>
      <!--
        2016-08-01 [024eaea]  Fix for 215: pgpool doesnt escalate ip in case of another node inavailability
        -->
        <para>
        Fix <productname>Pgpool-II</productname> doesn't escalate ip in case of another node inavailability. (bug 215) (Muhammad Usama)
        </para>
        <para>
        The heartbeat receiver fails to identify the heartbeat sender watchdog node when
        the heartbeat destination is specified in terms of an IP address while
        wd_hostname is configured as a hostname string or vice versa.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-07-29 [5bce300]  Fixing a coding mistake in watchdog code.
        -->
        <para>
        Fixing a coding mistake in watchdog code. (Muhammad Usama)
        </para>
        <para>
        <function>wd_issue_failover_lock_command()</function> function is supposed to forward command type
        passed in as an argument to the <function>wd_send_failover_sync_command()</function> function instead
        it was passing the NODE_FAILBACK_CMD command type.
        </para>
        <para>
        The commit also contains some log message enhancements.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-07-28 [541451e]  Display human readable output for backend node status.
        -->
        <para>
	    Display human readable output for backend node status. (Muhammad Usama)
        </para>
        <para>
        Changed the output of <link linkend="PCP-PROC-INFO">pcp_node_info</link> utility and show commands display human
        readable backend status string instead of internal status code.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-07-27 [3cbce4e]  Replace "MAJOR" macro to prevent occasional failure.
        -->
        <para>
          Replace "MAJOR" macro to prevent occasional failure. (Tatsuo Ishii)
        </para>
        <para>
          The macro calls <function>pool_virtual_master_db_node_id()</function> and then access
          backend->slots[id]->con using the node id returned. In rare cases, it
          could point to 0 (in case when the DB node is not connected), which
          gives access to con->major, then it causes a segfault.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-07-14 [866575c]  Fix for  [pgpool-hackers: 1501]  kind does not match error
        -->
        <para>
        Fix "kind mismatch" error message in <productname>Pgpool-II</productname>. (Muhammad Usama)
        </para>
        <para>
        Many of "kind mismatch..." errors are caused by notice/warning
        messages produced by one or more of the DB nodes. In this case now
        <productname>Pgpool-II</productname> forwards the messages to frontend, rather than throwing the
        "kind mismatch..." error. This would reduce the chance of "kind
        mismatch..."  errors.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-07-14 [680e329]  Fix handling of pcp_listen_addresses config parameter.
        -->
        <para>
	    Fix handling of <xref linkend="guc-pcp-listen-addresses"> config parameter. (Muhammad Usama)
        </para>
      </listitem>
      <listitem>
      <!--
        2016-07-07 [e245587]  Save and restore errno in each signal handler.
        -->
        <para>
	    Save and restore errno in each signal handler. (Tatsuo Ishii)
        </para>
      </listitem>
      <listitem>
      <!--
	    commit 0d1cdf96feb77de6f1dfc2d46ecd7467325d1f79
        2016-07-07 [0d1cdf9] Fix usage of wait(2) in pgpool main process
        -->
        <para>
	    Fix usage of <function>wait(2)</function> in pgpool main process. (Tatsuo Ishii)
        </para>
        <para>
        The usage of <function>wait(2)</function> in <productname>Pgpool-II</productname>
        main could cause infinite wait in the system call. Solution is,
        to use <function>waitpid(2)</function> instead of <function>wait(2)</function>.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-06-28 [bb41a1e]  Fix confusing error messages.
        -->
        <para>
        Fix that <function>pool_read()</function> does not emit error messages when <function>read(2)</function> returns -1 if
        <xref linkend="guc-fail-over-on-backend-error"> is off. (Tatsuo Ishii)
        </para>
      </listitem>
      <listitem>
      <!--
        2016-06-24 [a01624f]  Fix buffer over run problem in "show pool_nodes".
        -->
        <para>
        Fix buffer over run problem in "show pool_nodes". (Tatsuo Ishii)
        </para>
        <para>
        While processing "show pool_nodes", the buffer for hostname was too
        short. It should be same size as the buffer used for <filename>pgpool.conf</filename>.
        Problem reported by a twitter user who is using pgpool on AWS (which
        could have very long hostname).
        </para>
      </listitem>
      <listitem>
      <!--
        2016-06-17 [4c63d10]  Fixing [pgpool-hackers: 1638] pgpool-II does not use default configuration
        -->
        <para>
        Fix <ulink url="http://www.pgpool.net/pipermail/pgpool-hackers/2016-June/001638.html">
        [pgpool-hackers: 1638]</ulink> pgpool-II does not use default configuration. (Muhammad Usama)
        </para>
        <para>
         Configuration file not found should just throw a WARNING message
         instead of ERROR or FATAL.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-06-15 [226a21b]  Fix bug with load balance node id info on shmem
        -->
        <para>
	    Fix bug with load balance node id info on shmem. (Tatsuo Ishii)
        </para>
        <para>
        There are few places where the load balance node was mistakenly put on
        wrong place. It should be placed on:
        <programlisting>
ConnectionInfo *con_info[child id, connection pool_id, backend id].load_balancing_node].
        </programlisting>
        In fact it was placed on:
        <programlisting>
*con_info[child id, connection pool_id, 0].load_balancing_node].
        </programlisting>
        </para>
        <para>
        As long as the backend id in question is 0, it is ok. However while
        testing <productname>Pgpool-II</productname> 3.6's enhancement regarding failover, if primary
        node is 1 (which is the load balance node) and standby is 0, a client
        connecting to node 1 is disconnected when failover happens on node
        0. This is unexpected and the bug was revealed.
        </para>
        <para>
        It seems the bug was there since long time ago but it had not found
        until today by the reason above.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-06-09 [6ae42e7]  fix for 0000197: pgpool hangs connections to database.
        -->
        <para>
	    Fix for bug that pgpool hangs connections to database. (bug 197) (Muhammad Usama)
        </para>
        <para>
        The client connection was getting stuck when backend node and remote <productname>Pgpool-II</productname>
        node becomes unavailable at the same time. The reason was a missing command
        timeout handling in the function that sends the IPC commands to watchdog.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-06-08 [294cf4a]  Fix a posible hang during health checking
        -->
        <para>
	    Fix a posible hang during health checking. (bug 204) (Yugo Nagata)
        </para>
        <para>
        Helath checking was hang when any data wasn't sent
        from backend after <function>connect(2)</function> succeeded. To fix this,
        <function>pool_check_fd()</function> returns 1 when <function>select(2)</function> exits with
        EINTR due to SIGALRM while health checkking is performed.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-05-25 [a2d04ab]  Deal with the case when the primary is not node 0 in streaming replication mode.
        -->
        <para>
         Deal with the case when the primary is not node 0 in streaming replication mode. (Tatsuo Ishii)
        </para>
        <para>

         <ulink url="http://www.pgpool.net/mantisbt/view.php?id=194#c837">
         http://www.pgpool.net/mantisbt/view.php?id=194#c837</ulink> reported that if
         primary is not node 0, then statement timeout could occur even after
         bug194-3.3.diff was applied. After some investigation, it appeared
         that MASTER macro could return other than primary or load balance
         node, which was not supposed to happen, thus <function>do_query()</function> sends queries
         to wrong node (this is not clear from the report but I confirmed it in
         my investigation).
        </para>
        <para>
         <function>pool_virtual_master_db_node_id()</function>, which is called in MASTER macro
         returns query_context->virtual_master_node_id if query context
         exists. This could return wrong node if the variable has not been set
         yet. To fix this, the function is modified: if the variable is not
         either load balance node or primary node, the primary node id is
         returned.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-05-24 [69d3fae]  If statement timeout is enabled on backend and do_query() sends a
        -->
        <para>
	    If statement timeout is enabled on backend and <function>do_query()</function> sends a query to primary node, and all of following user queries are sent to
	    standby, it is possible that the next command, for example END, could
	    cause a statement timeout error on the primary, and a kind mismatch
	    error on pgpool-II is raised. (bug 194) (Tatsuo Ishii)
        </para>
        <para>
        This fix tries to mitigate the problem by sending sync message instead
        of flush message in <function>do_query()</function>, expecting that the sync message reset
        the statement timeout timer if we are in an explicit transaction. We
        cannot use this technique for implicit transaction case, because the
        sync message removes the unnamed portal if there's any.
        </para>
        <para>
        Plus, pg_stat_statement will no longer show the query issued by
        do_query() as "running".
        </para>
        <para>
        Plus, pg_stat_statement will no longer show the query issued by
        <function>do_query()</function> as "running".
        </para>
      </listitem>
      <listitem>
      <!--
        2016-05-22 [0c0e727]  Fix extended protocol handling in raw mode
        -->
        <para>
	    Fix extended protocol handling in raw mode. (Tatsuo Ishii)
        </para>
        <para>
        Bug152 reveals that extended protocol handling in raw mode (actually
        other than in stream mode) was wrong in <function>Describe(</function>) and <function>Close()</function>.
        Unlike stream mode, they should wait for backend response.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-05-20 [78c5d56]  Fix confusing comments in pgpool.conf
        -->
        <para>
	    Fix confusing comments in <filename>pgpool.conf</filename>. (Tatsuo Ishii)
        </para>
      </listitem>
      <listitem>
      <!--
        2016-05-11 [de905f6]  Fix documetation bug about raw mode
        -->
        <para>
	    Fix  Japanese and Chinese documetation bug about raw mode. (Yugo Nagata, Bo Peng)
        </para>
        <para>
        Connection pool is avalilable in raw mode.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-05-09 [9512999] Fix is_set_transaction_serializable() when
        SET default_transaction_isolation TO 'serializable'.
        -->
        <para>
	    Fix is_<function>set_transaction_serializable()</function> when
        SET default_transaction_isolation TO 'serializable'. (bug 191) (Bo Peng)
        </para>
        <para>
        SET default_transaction_isolation TO 'serializable' is sent to
        not only primary but also to standby server in streaming replication mode,
        and this causes an error. Fix is, in streaming replication mode,
        SET default_transaction_isolation TO 'serializable' is sent only to the
        primary server.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-04-13 [a5fdf78]  Fix extended protocol hang with empty query
        -->
        <para>
        Fix extended protocol hang with empty query. (bug 190) (Tatsuo Ishii)
        </para>
        <para>
        The fixes related to extended protocol cases in 3.5.1 broke the case
        of empty query.  In this case backend replies with "empty query
        response" which is same meaning as a command complete message. Problem
        is, when empty query response is received, pgpool does not reset the
        query in progress flag thus keeps on waiting for backend. However,
        backend will not send the ready for query message until it receives a
        sync message. Fix is, resetting the in progress flag after receiving
        the empty query response and reads from frontend expecting it sends a
        sync message.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-04-05 [64696fd]  Fix for [pgpool-general: 4569] PGPoolII-3.5 : segfault
        -->
        <para>
	    Fix for <ulink url="http://www.pgpool.net/pipermail/pgpool-general/2016-March/004627.html">
        [pgpool-general: 4569]</ulink> segfault during trusted_servers check. (Muhammad Usama)
        </para>
        <para>
        PostgreSQL's memory and exception manager APIs adopted by the <productname>Pgpool-II</productname> 3.4 are not
        thread safe and are causing the segmentation fault in the watchdog lifecheck
        process, as it uses the threads to ping configured trusted hosts for checking
        the upstream connections.
        Fix is to remove threads and use the child process approach instead.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-03-29 [f7723c8]  Validating the PCP packet length
        -->
        <para>
        Validating the PCP packet length. (Muhammad Usama)
        </para>
        <para>
        Without the validation check, a malformed PCP packet can crash the PCP child
        and/or can run the server out of memory by sending the packet with a
        very large data size.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-03-26 [d1c03f2]  Fix pgpool_setup to not confuse log output
        -->
        <para>
         Fix <link linkend="PGPOOL-SETUP">pgpool_setup </link> to not confuse log output. (Tatsuo Ishii)
        </para>
        <para>
         Before it simply redirects the stdout and stderr of pgpool process to
         a log file. This could cause log contents being garbled or even
         missed because of race condition caused by multiple process being
         writing concurrently. I and Usama found this while investigating the
         regression failure of 004.watchdog.

         To fix this, <link linkend="PGPOOL-SETUP">pgpool_setup </link> now generates startall script so that pgpool
         now sends stdout/stderr to cat command and cat writes to the log file
         (It seems the race condition does not occur when writing to a pipe).
        </para>
      </listitem>
      <listitem>
      <!--
        2016-03-07 [e55c230]  Fix for [pgpool-general: 4519] Worker Processes Exit and Are Not Re-spawned
        -->
        <para>
	    Fix for <ulink url="http://www.pgpool.net/pipermail/pgpool-general/2016-March/004577.html">
	    [pgpool-general: 4519]</ulink> Worker Processes Exit and Are Not Re-spawned. (Muhammad Usama)
        </para>
        <para>
        The problem was due to a logical mistake in the code for checking the exiting
        child process type when the watchdog is enabled.
        I have also changed the severity of the message from FATAL to LOG, emitted
        for child exits due to max connection reached.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-03-04 [67ac541]  Fix pgpool hung after receiving error state from backend
        -->
        <para>
	    Fix pgpool hung after receiving error state from backend. (bug #169) (Tatsuo Ishii)
        </para>
        <para>
        This could happend if we execute an extended protocol query and it
        fails.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-03-03 [bb295a2]  Fix query stack problems in extended protocol case.
        -->
        <para>
	    Fix query stack problems in extended protocol case. (bug 167, 168) (Tatstuo Ishii)
        </para>
        <para>
        </para>
      </listitem>
      <listitem>
      <!--
        2016-03-03 [63a0b70]  Fix yet another reset query stuck problem
        -->
        <para>
	    Fix <ulink url="http://www.pgpool.net/pipermail/pgpool-hackers/2016-March/001440.html">
        [pgpool-hackers: 1440]</ulink> yet another reset query stuck problem. (Tatsuo Ishii)
        </para>
        <para>
        After receiving X message from frontend, if <productname>Pgpool-II</productname> detects EOF on
        the connection before sending reset query, <productname>Pgpool-II</productname> could wait for
        backend which had not received the reset query. To fix this, if EOF
        received, treat this as FRONTEND_ERROR, rather than ERROR.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-02-22 [f1cfeb6]  Yet another reset query stuck problem fix. [pgpool-general: 4265]
        -->
        <para>
	    Fix for <ulink url="http://www.pgpool.net/pipermail/pgpool-general/2015-December/004323.html">
	    [pgpool-general: 4265]</ulink> another reset query stuck problem. (Muhammad Usama)
        </para>
        <para>
        The solution is to report FRONTEND_ERROR instead of simple ERROR when
        pool_flush on front-end socket fails.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-02-12 [c50f357] Fixing pgpool-recovery module compilation issue with PostgreSQL 9.6
        -->
        <para>
	    Fixing pgpool-recovery module compilation issue with <productname>PostgreSQL</productname> 9.6. (Muhammad Usama)
        </para>
        <para>
        Incorporating the change of function signature for
        <function>GetConfigOption()</function> functions in <productname>PostgreSQL</productname> 9.6
        </para>
      </listitem>
      <listitem>
      <!--
        2016-02-03 [48e9d4b]  Fix for [pgpool-II 0000166]: compile issue on freebsd
        -->
        <para>
	    Fix compile issue on freebsd. (Muhammad Usama)
        </para>
        <para>
        Add missing include files. The patch is contributed by
        the bug reporter and enhanced a little by me.
        </para>
      </listitem>
      <listitem>
      <!--
        2016-02-01 [6688332]  Fix regression test to check timeout of each test
        -->
        <para>
	    Fix regression test to check timeout of each test. (Yugo Nagata)
        </para>
      </listitem>
      <listitem>
      <!--
        2016-02-01 [44f43cc]  Add some warning messages for wd_authkey hash calculation failure
        -->
        <para>
	    Add some warning messages for <xref linkend="guc-wd-authkey"> hash calculation failure. (Yugo Nagata)
        </para>
        <para>
        Sometimes <xref linkend="guc-wd-authkey"> calculation fails for some reason other than
        authkey mismatch. The additional messages make these distingushable
        for each other.
        </para>
      </listitem>

    </itemizedlist>

  </sect2>

</sect1>
