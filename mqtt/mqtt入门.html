<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2016-12-13 周二 18:09 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MQTT入门</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../style/my-org-worg.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">MQTT入门</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org119a382">1. + 参考文档</a></li>
<li><a href="#org900542d">2. 关键词解释</a></li>
<li><a href="#org13b58fc">3. MQTT V3.1协议规范摘要</a></li>
<li><a href="#org7eea7d3">4. mqtt协议详解</a>
<ul>
<li><a href="#org7b265b1">4.1. 协议格式</a></li>
<li><a href="#org4a50fbe">4.2. 固定头部</a></li>
<li><a href="#org64ee78b">4.3. 可变头部</a></li>
<li><a href="#orgcd51799">4.4. 有效负载</a></li>
<li><a href="#org18a27ff">4.5. 消息标识符</a></li>
<li><a href="#orged5121b">4.6. MQTT和UTF-8（MQTT and UTF-8）</a></li>
<li><a href="#org8ebb2a3">4.7. 未使用的位（Unused bits）</a></li>
</ul>
</li>
<li><a href="#org76da9c2">5. 命令消息</a>
<ul>
<li><a href="#orgaa3b9b8">5.1. CONNECT - 客户端请求连接服务器</a></li>
<li><a href="#orgae0e934">5.2. CONNACK - 连接确认</a></li>
<li><a href="#org64d131c">5.3. PUBLISH - 发布消息</a></li>
<li><a href="#org96d765d">5.4. PUBACK - 发布确认</a></li>
<li><a href="#org26e8e82">5.5. PUBREC - 发布接收（有保证的交付第1部分）</a></li>
<li><a href="#org566c4ae">5.6. PUBREL - 发布释放（有保证的交付第2部分）</a></li>
<li><a href="#orgd42c7a2">5.7. PUBCOMP - 发布完成（有保证的交付第3部分）</a></li>
<li><a href="#org455bf29">5.8. SUBSCRIBE - 客户端订阅主题</a></li>
<li><a href="#org0a9442a">5.9. SUBACK - 订阅确认</a></li>
<li><a href="#org9c7cba2">5.10. UNSUBSCRIBE - 客户端取消订阅主题</a></li>
<li><a href="#orgf44b281">5.11. UNSUBACK - 取消订阅确认</a></li>
<li><a href="#org0f0b3d7">5.12. PINGREQ - PING请求</a></li>
<li><a href="#org0d08bcc">5.13. PINGRESP - PING回复</a></li>
<li><a href="#org75a8103">5.14. DISCONNECT - 断开连接通知</a></li>
</ul>
</li>
<li><a href="#orgd7c8c2d">6. 消息流</a>
<ul>
<li><a href="#orgff346e1">6.1. 交付质量级别和消息流（Quality of Service levels and flows）</a></li>
<li><a href="#org93c9244">6.2. 消息重传</a></li>
<li><a href="#orgf58fc43">6.3. 消息排序</a></li>
</ul>
</li>
<li><a href="#org3868de5">7. mosquitto实战</a></li>
</ul>
</div>
</div>

<div id="outline-container-org119a382" class="outline-2">
<h2 id="org119a382"><span class="section-number-2">1</span> + 参考文档</h2>
<div class="outline-text-2" id="text-1">
<pre class="example">
http://www.cnblogs.com/shanyou/p/4085802.htmlx
http://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/mqtt-v3r1.html
</pre>
</div>
</div>


<div id="outline-container-org900542d" class="outline-2">
<h2 id="org900542d"><span class="section-number-2">2</span> 关键词解释</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>MQTT</li>
</ul>
<pre class="example">
Message Queuing Telemetry Transport，消息队列遥测传输,是IBM开发的一个即时通讯协议,

被用来当做传感器和致动器（比如通过Twitter让房屋联网）的通信协议。
</pre>

<ul class="org-ul">
<li>Qos</li>
</ul>
<pre class="example">
QoS（Quality of Service）服务质量，是网络的一种安全机制， 是用来解决网络延迟和阻塞

等问题的一种技术。 在正常情况下，如果网络只用于特定的无时间限制的应用系统，并不需要QoS，

比如Web应用，或E-Mail设置等。但是对关键应用和多媒体应用就十分必要。当网络过载或拥塞时，

xQoS 能确保重要业务量不受延迟或丢弃，同时保证网络的高效运行。
</pre>

<ul class="org-ul">
<li>Pub</li>
</ul>
<pre class="example">
发布消息相关
</pre>

<ul class="org-ul">
<li>Sub</li>
</ul>
<pre class="example">
订阅消息相关
</pre>
</div>
</div>


<div id="outline-container-org13b58fc" class="outline-2">
<h2 id="org13b58fc"><span class="section-number-2">3</span> MQTT V3.1协议规范摘要</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>摘要</li>
</ul>
<pre class="example">
MQTT是一个轻两量界级的基于代理的发布/订阅式消息传输协议，它的设计目标是开放，简单，轻量和

易于实现，这些特征使它适用于各种受限制环境。比如：网络不可靠或低带宽环境中，硬件资源紧张的

嵌入式设备中
</pre>

<ul class="org-ul">
<li>特性</li>
</ul>
<pre class="example">
1 使用发布/订阅消息模式，提供一对多的消息发布

2 消息传输对有效负载内容不可知

3 使用TCP/IP提供基础网络链接
</pre>

<ul class="org-ul">
<li>Qos的三个级别</li>
</ul>
<pre class="example">
1 至多一次：消息可能丢失。比如环境传感器数据 1次/分，丢失一次也无所谓，下条很快又来了

2 至少一次： 无论如何都要确保消息的到达，消息可能重复发生

3 只有一次： 无论如何都要确保消息到达有且只能有一次。比如：计费系统，重复或者丢失都是错误的。
</pre>


<ul class="org-ul">
<li>轻量传输</li>
</ul>
<pre class="example">
固定头部只有2个字节，开销很小，降低了网络流量
</pre>

<ul class="org-ul">
<li>代理</li>

<li>发布</li>

<li>订阅</li>
</ul>
</div>
</div>


<div id="outline-container-org7eea7d3" class="outline-2">
<h2 id="org7eea7d3"><span class="section-number-2">4</span> mqtt协议详解</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-org7b265b1" class="outline-3">
<h3 id="org7b265b1"><span class="section-number-3">4.1</span> 协议格式</h3>
<div class="outline-text-3" id="text-4-1">
<pre class="example">
MQTT命令消息一般组成结构：

固定头部 +  [可变头部] + [ 有效载荷]

有效载荷：也称为消息体

固定头部：一定有

可变头部和消息体：只有某些特定的类型消息才有
</pre>
</div>
</div>


<div id="outline-container-org4a50fbe" class="outline-3">
<h3 id="org4a50fbe"><span class="section-number-3">4.2</span> 固定头部</h3>
<div class="outline-text-3" id="text-4-2">

<div class="figure">
<p><img src="./img/固定头部.png" alt="固定头部.png" />
</p>
</div>

<pre class="example">
Byte 1：
       包含消息类型和标志字段 
Byte 2：
       包含剩余长度字段（至少1个字节，最多4个字节），以大端模式存储的（高字节-&gt;内存低地址）

字节范围[ 2 - 5 字节]
</pre>

<ul class="org-ul">
<li>MessageType ( byte 1，bits 7-4 ）</li>
</ul>
<pre class="example">
占4 bit，0和15为保留数值
         0 =&gt;                           // 保留字
         1 =&gt; "CONNECT"            // 客户端请求连接服务器
         2 =&gt; "CONNACK"            // 连接确认
         3 =&gt; "PUBLISH"            // 发布消息
         4 =&gt; "PUBACK"             // 发布确认
         5 =&gt; "PUBREC"             // 发布接收（有保证的交付第1部分）
         6 =&gt; "PUBREL"             // 发布释放（有保证的交付第2部分）
         7 =&gt; "PUBCOMP"            // 发布完成（有保证的交付第3部分）
         8 =&gt; "SUBSCRIBE"          // 客户端订阅请求
         9 =&gt; "SUBACK"             // 订阅确认
        10 =&gt; "UNSUBSCRIBE"        // 客户端取消订阅请求
        11 =&gt; "UNSUBACK"           // 取消订阅确认
        12 =&gt; "PINGREQ"            // PING请求
        13 =&gt; "PINGRESP"           // PING响应
        14 =&gt; "DISCONNECT"         // 客户端断开连接
        15 =&gt;                           // 保留字
</pre>


<ul class="org-ul">
<li>DUP flag ( byte 1，bits 3 ）</li>
</ul>
<pre class="example">
服务器试图重发PUBLISH、PUBREL，客户端试图重发SUBSRIBE、UNSUBSCRIBE消息时，

该标志位要被置位（即设为1）。这适用于消息的QoS标志值大于0的情况，此时消息确认是必需的。

当DUP位被置位时，可变头部将包含一个消息ID。
</pre>


<ul class="org-ul">
<li>Qos level ( byte 1，bits 2-1 ）</li>
</ul>

<div class="figure">
<p><img src="./img/qos级别.png" alt="qos级别.png" />
</p>
</div>
<pre class="example">
该标志位标明 PUBLISH 消息的交付质量级别。具体的QoS级别如下表所示。
00  0  &lt;=1  至多一次：消息可能丢失。比如环境传感器数据 1次/分，丢失一次也无所谓，下条很快又来了

01  1  &gt;=1  至少一次： 无论如何都要确保消息的到达，消息可能重复发生

10  2 =1   只有一次： 无论如何都要确保消息到达有且只能有一次。比如：计费系统，重复或者丢失都是错误的。 

11  3   保留
</pre>

<ul class="org-ul">
<li>Retain ( byte 1，bits 0 ）</li>
</ul>
<pre class="example">
该标志位只用于PUBLISH消息。当一个客户端发送一条PUBLISH消息给服务，假设该该消息所属的主题

(topic)为topicA，如果该标志位被置为（1），服务器在将该消息发布给当前的所有topicA订阅者

之后，还应该保持这条消息。

当topicA出现了一个新的订阅者，则topicA的最后一条保持消息应当分发给该订阅者。如果不存在保持

消息，则什么也不用做。

一句话：当消息发布者发消息的间隔比较长，该位为1，可以让新的订阅者立马收到历史消息的最后一条。

当服务器收到新消息时，在给客户端发送前，将该位清0（即不置位）

如果是保持消息（1），应当服务器重启之后仍能保留。

如果服务器收到消息体长度为0，则可以删除该保持消息。
</pre>

<ul class="org-ul">
<li>byte2 - byte5( 剩余长度 )</li>
</ul>
<pre class="example">
该字段表示当前消息的剩余内容的字节数，包括可变头部和有效载荷（消息体）的数据。

该字段本身的字节数是根据可变头部和有效载荷的长度不同而变化的。

每个字节编码7-0bit的值（127）和一个“延续位”
</pre>


<p>
byte 2
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">31</th>
<th scope="col" class="org-right">30</th>
<th scope="col" class="org-right">29</th>
<th scope="col" class="org-right">28</th>
<th scope="col" class="org-right">27</th>
<th scope="col" class="org-right">26</th>
<th scope="col" class="org-right">25</th>
<th scope="col" class="org-right">24</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>

<p>
2<sup>7</sup>-1=0X
</p>

<p>
byte 3
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">31</th>
<th scope="col" class="org-right">30</th>
<th scope="col" class="org-right">29</th>
<th scope="col" class="org-right">28</th>
<th scope="col" class="org-right">27</th>
<th scope="col" class="org-right">26</th>
<th scope="col" class="org-right">25</th>
<th scope="col" class="org-right">24</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<hr  />
<p>
byte 4
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">31</th>
<th scope="col" class="org-right">30</th>
<th scope="col" class="org-right">29</th>
<th scope="col" class="org-right">28</th>
<th scope="col" class="org-right">27</th>
<th scope="col" class="org-right">26</th>
<th scope="col" class="org-right">25</th>
<th scope="col" class="org-right">24</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<hr  />

<p>
byte 5
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">31</th>
<th scope="col" class="org-right">30</th>
<th scope="col" class="org-right">29</th>
<th scope="col" class="org-right">28</th>
<th scope="col" class="org-right">27</th>
<th scope="col" class="org-right">26</th>
<th scope="col" class="org-right">25</th>
<th scope="col" class="org-right">24</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<hr  />



<div class="figure">
<p><img src="./img/剩余字段.png" alt="剩余字段.png" />
</p>
</div>
<pre class="example">
好好理解下，如何计算字节数，编码方案

该编码方案的算法如下所示，输入为一个十进制数（X），输出为编码后的结果。
do
  digit = X MOD 128
  X = X DIV 128
  // if there are more digits to encode, set the top bit of this digit
  if ( X &gt; 0 )
    digit = digit OR 0x80
  endif
  'output' digit
while ( X&gt; 0 )


相应地，剩余长度字段的解码算法如下所示：

multiplier = 1
value = 0
do
  digit = 'next digit from stream'
  value += (digit AND 127) * multiplier
  multiplier *= 128
while ((digit AND 128) != 0)
当该解码算法终止，value等于剩余长度的字节数。

可认为剩余长度字段虽然是固定的，即肯定是有的，但该字段的长度却是变化的（1-4字节）。
</pre>
</div>
</div>



<div id="outline-container-org64ee78b" class="outline-3">
<h3 id="org64ee78b"><span class="section-number-3">4.3</span> 可变头部</h3>
<div class="outline-text-3" id="text-4-3">
<pre class="example">
某些类型的MQTT命令消息还包含了一个可变的头部，它位于固定头部和消息体之间。

可变的剩余字段（1-4字节）不是可变头部的一部分。剩余长度字段的值不包括可变字段的长度，

可变字段的值只包括可变头部和消息体。
</pre>

<div class="figure">
<p><img src="./img/可变头部.png" alt="可变头部.png" />
</p>
</div>
<ul class="org-ul">
<li>协议名称（Protocol name）</li>
</ul>
<pre class="example">
协议名称字段只用于 MQTT CONNECT 消息的可变头部中。该字段以UTF编码方式显示协议名称：MQIsdp

len = 1 - 2 字节

content 3 - 8 字节
</pre>


<ul class="org-ul">
<li>协议版本（Protocol version）</li>
</ul>
<pre class="example">
协议版本字段只用于 MQTT CONNECT 消息的可变头部中。

该字段用8位无符号值来表示客户端所使用的协议修订级别。当前版本协议中该字段的值为3（0x03），如下表所示
协议版本号，v3 也是固定的。
二进制           十进制
00 00 00 11  =&gt; 3
</pre>

<div class="figure">
<p><img src="./img/协议版本.png" alt="协议版本.png" />
</p>
</div>

<ul class="org-ul">
<li>连接标志 Connect Flag</li>
</ul>
<pre class="example">
该字段用于 CONNECT 消息的可变头部中，占1字节，包括Clean session、Will、Will QoS和Retain标志。
</pre>


<ul class="org-ul">
<li>Connect Flag之bit 0</li>
</ul>
<pre class="example">
连接标志中的第0位在目前协议版本中没有使用到，保留为将来使用。
</pre>

<ul class="org-ul">
<li>Connect Flag之bit 1 （Clean session）</li>
</ul>

<div class="figure">
<p><img src="./img/clean-session.png" alt="clean-session.png" />
</p>
</div>


<pre class="example">
如果没有被置位（即值为0），则当客户端断线时，服务器必须保存该客户端的订阅消息，包括断线期间发布的该客户端

订阅的主题中交付质量级别为QoS 1和QoS2的消息，QoS 0级别的消息由于只是尽可能的交付，所以它永远不会被存储保持

这样当客户端重连时，这部分消息能确保被送达到客户端。

同时，服务器还必须保持客户端在断线的那个时刻正在传输中的消息的状态，直到客户端重新连接。


如果被置位（即值为1），则服务器必须丢弃任何之前保持的该客户端的信息。将该连接视为“不存在（Clean）”。


同时，当客户端断线时，服务器必须丢弃其所有状态。
</pre>


<ul class="org-ul">
<li>Connect Flag之bit 2 （Will Flag）</li>
</ul>

<div class="figure">
<p><img src="./img/will-flag.png" alt="will-flag.png" />
</p>
</div>

<pre class="example">
Will消息是指当服务器与客户端通信过程中出现故障或客户端在保活时间内没有与服务器保持正常交流时，服务器特意发给客户端的消息。

当客户端通过发送 DISCONNECT 消息正常断开时，Will消息不会发送。

如果Will-flag标志被置位，则Will QoS标志和Will Retain标志的设置将会发生作用，同时，在有效载荷里必须填写Will主题和Will消息内容字段
</pre>



<ul class="org-ul">
<li>Connect Flag之bit 3-4 （Will QoS）</li>
</ul>

<div class="figure">
<p><img src="./img/will-qos.png" alt="will-qos.png" />
</p>
</div>
<pre class="example">
Will QoS标志用来设置当客户端异常离线时，服务器发送的Will消息的交付质量级别。Will消息的内容在客户端发送的 

CONNECT 消息里的有效载荷里填写。

如果Will-flag标志被置位，则Will QoS字段必须填写，否则该字段的值将被忽略。

Will QoS字段的可选值有0（0x00），1（0x01）和2（0x02），格式如下表所示。
</pre>

<ul class="org-ul">
<li>Connect Flag之bit 3-4 （Will QoS）</li>
</ul>

<div class="figure">
<p><img src="./img/retain-flags.png" alt="retain-flags.png" />
</p>
</div>
<pre class="example">
Will Retain标志指明服务器是否需要保持客户端异常离线时发送给客户端的Will消息。

如果Will标志被置位，则Will Retain标志必须填写，否则其将被忽略。该标志的格式如下表所示。
</pre>

<ul class="org-ul">
<li>Connect Flag之bit 5 （Will Retain）</li>
</ul>
<pre class="example">
Will Retain标志指明服务器是否需要保持客户端异常离线时发送给客户端的Will消息。

如果Will标志被置位，则Will Retain标志必须填写，否则其将被忽略。该标志的格式如下表所示。
</pre>



<ul class="org-ul">
<li>Connect Flag之bit 6-7 （User name and password )</li>
</ul>
<pre class="example">
客户端在连接服务器时可以指定用户名和密码，通过将用户名标志和密码标志（可选）置位表明在 CONNECT 消息的有效载荷里包含有用户名和密码。

如果将用户名标志置位，则必须在有效载荷里填写用户名字段，否则用户名字段将被忽略。同样地，如果密码标志被置位，则必须在有效载荷里填写密码字段，

否则密码字段将被忽略。只提供密码而不提供用户名是不合法的。
</pre>



<ul class="org-ul">
<li>保活计时器（Keep Alive timer）</li>
</ul>

<div class="figure">
<p><img src="./img/keep-alive-timer.png" alt="keep-alive-timer.png" />
</p>
</div>
<pre class="example">
保活计时器用于MQTT CONNECT 消息的可变头部中。


保活计时器定义了服务器收到客户端消息的最大时间间隔，它以秒为单位。它使得服务器不需要等待漫长的TCP/IP超时就可以检测与客户端的网络连接是否断开

它使得服务器不需要等待漫长的TCP/IP超时就可以检测与客户端的网络连接是否断开。


客户端有义务在每个保活时间间隔内至少发送一条消息给服务器。如果这期间没有业务相关的消息要发送，客户端则发送一个 PINGREQ 消息给服务器，

相应地服务器返回一个 PINGRESQ 消息给客户端。

如果服务器在1.5个保活时间（可宽容0.5个保活时间）内都没有收到客户端的消息，则服务器将其视为客户端发送了一个 DISCONNECT 消息，

并断开与客户端的连接。这个动作不影响客户端的订阅。

如果客户端在发送 PINGQ 后的一个保活时间内没有收到服务器发来的 PINGRESP 消息，则客户端可以关闭TCP/IP套接字连接

保活计时器用2个字节来表示，时间单位为秒。实际设定的值由特定应用决定，不过通常它的值都设为数分钟，最大值接近18个小时。如果设为0，则表示客户端不断线。

保活计时器的格式如下表所示。2个字节的顺序为先 MSB，再 LSB(大端模式)。
</pre>


<ul class="org-ul">
<li>连接返回码（Connect return code）</li>
</ul>
<pre class="example">
连接返回码用于 CONNACK 消息的可变头部中。

这个字段用一个无符号字节来表示返回码。这些值的含义如下表所示。值为0的返回码通常表示连接成功。
</pre>


<ul class="org-ul">
<li>主题名（Topic name）</li>
</ul>
<pre class="example">
主题名用于 PUBLISH 消息的可变头部中。

主题名决定消息要发送到哪个信息通道。订阅者使用主题名来决定他们要从哪些信息通道接收消息。

主题名是一个UTF编码字符串。主题名支持的最大字符度为32767。
</pre>
</div>
</div>


<div id="outline-container-orgcd51799" class="outline-3">
<h3 id="orgcd51799"><span class="section-number-3">4.4</span> 有效负载</h3>
<div class="outline-text-3" id="text-4-4">
<p>
以下类型的MQTT命令消息拥有一个有效载荷：
</p>

<ul class="org-ul">
<li>CONNECT</li>
</ul>
<pre class="example">
该有效载荷包含了一个或多个UTF-8编码字符串。它们包括标识客户端的唯一标识符、Will主题和消息、要使用的用户名和密码。

其中只有第一项是必选的，其余的取决于可变消息头部中的标志置位情况。
</pre>
<ul class="org-ul">
<li>SUBSCRIBE</li>
</ul>
<pre class="example">
该有效载荷包含一系列要订阅的主题名，以及每个主题的QoS级别。这些字符串都是UTF编码的。
</pre>
<ul class="org-ul">
<li>SUBACK</li>
</ul>
<pre class="example">
该有效载荷包含一系列授权过的QoS级别。它们是服务器管理员允许授权给客户端订阅的各个主题的QoS级别。授权的QoS级别顺序与相应订阅的主题的顺序保持一致。
</pre>
<ul class="org-ul">
<li>PUBLISH</li>
</ul>
<pre class="example">
该有效载荷只包含应用特定的数据。协议不对数据的属性和内容作任何假设，协议把消息的这部分内容视为一个BLOB。

如果你想要对有效载荷数据进行压缩，你必须自己在有效载荷里定义合适的标志来处理压缩事宜。你不能在固定状况或可变头部里定义与特定应用相关的标志。
</pre>
</div>
</div>



<div id="outline-container-org18a27ff" class="outline-3">
<h3 id="org18a27ff"><span class="section-number-3">4.5</span> 消息标识符</h3>
<div class="outline-text-3" id="text-4-5">
<pre class="example">
消息表示符用于以下MQTT消息的可变头部中，PUBLISH，PUBACK，PUBREC，PUBREL，PUBCOMP，SUBSCRIBE，SUBACK，UNSUBSCRIBE，UNSUBACK。

消息标识符字段只存在于固定头部中QoS标志值为1或2的消息中。

在同一个方向上的在传消息ID必须是唯一的。它通常是逐个消息递增的，但不强制如此。

客户端与它所连接的服务器一样，都需要维护自己的消息ID列表，二者的消息ID列表互不影响。

客户端在发送一个消息ID为1的 PUBLISH 消息的同时也有可能收到来自服务器的消息ID为1的 PUBLISH 消息。

表示消息ID的2个字节的顺序为先 MSB，再 LSB（大端模式）。

不要使用值为0的消息ID。它是作为无效消息ID保留的。
</pre>
</div>
</div>



<div id="outline-container-orged5121b" class="outline-3">
<h3 id="orged5121b"><span class="section-number-3">4.6</span> MQTT和UTF-8（MQTT and UTF-8）</h3>
<div class="outline-text-3" id="text-4-6">
<pre class="example">
UTF-8是一种针对Unicode的可变长度字符编码，它优化了ASCII字符集的编码，以支持基于文本的通信。

在MQTT中，字符串编码的头2个字节用来记录字符串的长度，如下表所示

字符串长度表示所有字符经过UTF-8编码后的字节数，而不是字符串中字符的个数。例如，经过UTF-8编码后的字符串 OTWP 如下表所示。
</pre>
</div>
</div>

<div id="outline-container-org8ebb2a3" class="outline-3">
<h3 id="org8ebb2a3"><span class="section-number-3">4.7</span> 未使用的位（Unused bits）</h3>
<div class="outline-text-3" id="text-4-7">
<pre class="example">
任何表明为未使用的位都应当置为0
</pre>
</div>
</div>
</div>


<div id="outline-container-org76da9c2" class="outline-2">
<h2 id="org76da9c2"><span class="section-number-2">5</span> 命令消息</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-orgaa3b9b8" class="outline-3">
<h3 id="orgaa3b9b8"><span class="section-number-3">5.1</span> CONNECT - 客户端请求连接服务器</h3>
</div>

<div id="outline-container-orgae0e934" class="outline-3">
<h3 id="orgae0e934"><span class="section-number-3">5.2</span> CONNACK - 连接确认</h3>
</div>

<div id="outline-container-org64d131c" class="outline-3">
<h3 id="org64d131c"><span class="section-number-3">5.3</span> PUBLISH - 发布消息</h3>
</div>

<div id="outline-container-org96d765d" class="outline-3">
<h3 id="org96d765d"><span class="section-number-3">5.4</span> PUBACK - 发布确认</h3>
</div>

<div id="outline-container-org26e8e82" class="outline-3">
<h3 id="org26e8e82"><span class="section-number-3">5.5</span> PUBREC - 发布接收（有保证的交付第1部分）</h3>
</div>

<div id="outline-container-org566c4ae" class="outline-3">
<h3 id="org566c4ae"><span class="section-number-3">5.6</span> PUBREL - 发布释放（有保证的交付第2部分）</h3>
</div>

<div id="outline-container-orgd42c7a2" class="outline-3">
<h3 id="orgd42c7a2"><span class="section-number-3">5.7</span> PUBCOMP - 发布完成（有保证的交付第3部分）</h3>
</div>

<div id="outline-container-org455bf29" class="outline-3">
<h3 id="org455bf29"><span class="section-number-3">5.8</span> SUBSCRIBE - 客户端订阅主题</h3>
</div>

<div id="outline-container-org0a9442a" class="outline-3">
<h3 id="org0a9442a"><span class="section-number-3">5.9</span> SUBACK - 订阅确认</h3>
</div>
<div id="outline-container-org9c7cba2" class="outline-3">
<h3 id="org9c7cba2"><span class="section-number-3">5.10</span> UNSUBSCRIBE - 客户端取消订阅主题</h3>
</div>

<div id="outline-container-orgf44b281" class="outline-3">
<h3 id="orgf44b281"><span class="section-number-3">5.11</span> UNSUBACK - 取消订阅确认</h3>
</div>

<div id="outline-container-org0f0b3d7" class="outline-3">
<h3 id="org0f0b3d7"><span class="section-number-3">5.12</span> PINGREQ - PING请求</h3>
</div>

<div id="outline-container-org0d08bcc" class="outline-3">
<h3 id="org0d08bcc"><span class="section-number-3">5.13</span> PINGRESP - PING回复</h3>
</div>

<div id="outline-container-org75a8103" class="outline-3">
<h3 id="org75a8103"><span class="section-number-3">5.14</span> DISCONNECT - 断开连接通知</h3>
</div>
</div>

<div id="outline-container-orgd7c8c2d" class="outline-2">
<h2 id="orgd7c8c2d"><span class="section-number-2">6</span> 消息流</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-orgff346e1" class="outline-3">
<h3 id="orgff346e1"><span class="section-number-3">6.1</span> 交付质量级别和消息流（Quality of Service levels and flows）</h3>
</div>
<div id="outline-container-org93c9244" class="outline-3">
<h3 id="org93c9244"><span class="section-number-3">6.2</span> 消息重传</h3>
</div>
<div id="outline-container-orgf58fc43" class="outline-3">
<h3 id="orgf58fc43"><span class="section-number-3">6.3</span> 消息排序</h3>
</div>
</div>



<div id="outline-container-org3868de5" class="outline-2">
<h2 id="org3868de5"><span class="section-number-2">7</span> mosquitto实战</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>mosquitto服务端安装</li>
</ul>
<pre class="example">
sudo apt-get install mosquitto
</pre>

<ul class="org-ul">
<li>mosquitto客户端安装</li>
</ul>
<pre class="example">
sudo apt install mosquitto-clients
</pre>

<ul class="org-ul">
<li>mosquitto sub订阅主题消息</li>
</ul>
<pre class="example">
mosquitto_sub -v -t music
</pre>


<ul class="org-ul">
<li>mosquitto pub发布主题消息</li>
</ul>
<pre class="example">
osquitto_pub -t music  -m "周杰伦"
</pre>

<ul class="org-ul">
<li>mosquitto sub订阅主题消息得到的结果</li>
</ul>
<pre class="example">
⋊&gt; ~ mosquitto_sub -v -t music 
music 周杰伦
</pre>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2016-12-13 周二 18:09</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
